<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Sécurité IA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- Thème Dark Mode & Global --- */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 24px;
        }

        h1, h2, h3 {
            font-weight: 500;
            margin-top: 0;
        }

        /* --- La Grille du Dashboard --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 20px;
        }

        .tile {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        /* --- Tuile 1 : Pie Chart --- */
        #pie-chart-tile {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            height: 450px; /* Hauteur fixe pour empêcher la croissance */
            padding-bottom: 32px; /* Padding supplémentaire en bas */
        }

        /* --- Tuile 2 : Line Chart (s'étend sur 2 colonnes) --- */
        #line-chart-tile {
            grid-column: 2 / 4; /* S'étend de la colonne 2 à 4 */
            grid-row: 1 / 2;
            height: 450px; /* Hauteur fixe pour empêcher la croissance */
            padding-bottom: 32px; /* Padding supplémentaire en bas */
        }

        /* --- Tuile 3 : 5 Récents --- */
        #recent-tile {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            min-height: 450px;
            padding-bottom: 32px; /* Padding supplémentaire en bas */
        }
        
        #recent-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Prend l'espace restant */
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* Espace bien les 5 éléments */
        }

        #recent-list li {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            border-left: 4px solid #444; /* Bordure par défaut */
        }
        
        #recent-list li:last-child {
            margin-bottom: 0;
        }

        #recent-list li strong {
            display: block;
            font-size: 1rem;
            color: #fff;
            margin-bottom: 4px;
        }
        
        /* --- Tuile 4 : Note Moyenne --- */
        #overall-avg-tile {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            align-items: center; /* Centre le contenu */
            justify-content: center; /* Centre le contenu */
            text-align: center;
            min-height: 450px;
            padding-bottom: 32px; /* Padding supplémentaire en bas */
            /* Petit dégradé comme demandé */
            background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
        }

        .big-number {
            font-size: 6rem;
            font-weight: 700;
            line-height: 1;
        }

        /* --- Tuile 5 : Sujets Problématiques --- */
        #topics-tile {
            grid-column: 3 / 4;
            grid-row: 2 / 3;
            min-height: 450px;
            padding-bottom: 32px; /* Padding supplémentaire en bas */
        }

        .topics-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .topics-list li {
            background-color: #2a2a2a;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .topics-list .topic-name {
            font-weight: 500;
        }
        
        .topics-list .topic-count {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
        }
        
        /* Styling dynamique pour le top 3 (comme demandé) */
        .topics-list li:nth-child(1) {
            background-color: #5d2a2a; /* Fond rouge sombre */
            font-size: 1.1rem;
        }
        .topics-list li:nth-child(1) .topic-count { color: #f44336; }
        
        .topics-list li:nth-child(2) {
            background-color: #5c4120; /* Fond orange sombre */
            font-size: 1.05rem;
        }
        .topics-list li:nth-child(2) .topic-count { color: #ff9800; }
        

        /* --- Canvas sizing --- */
        canvas {
            max-height: 100%;
            max-width: 100%;
        }

        /* --- Classes de couleur utilitaires --- */
        .text-green { color: #4CAF50; }
        .text-yellow { color: #FFEB3B; }
        .text-red { color: #F44336; }
        
        .risk-high { color: #F44336; font-weight: 700; }
        .risk-medium { color: #FF9800; }
        .risk-low { color: #FFEB3B; }
        .risk-none { color: #4CAF50; }
        
        /* Classes pour les bordures de la liste récente */
        #recent-list li.border-high { border-left-color: #F44336; }
        #recent-list li.border-medium { border-left-color: #FF9800; }
        #recent-list li.border-low { border-left-color: #FFEB3B; }
        #recent-list li.border-none { border-left-color: #4CAF50; }

    </style>
</head>
<body>

    <h1 style="text-align: center; margin-bottom: 24px;">Dashboard de Sécurité des Prompts IA</h1>

    <div class="dashboard-grid">

        <div class="tile" id="pie-chart-tile">
            <h3>Niveaux de Risque (Total)</h3>
            <canvas id="riskPieChart"></canvas>
        </div>

        <div class="tile" id="line-chart-tile">
            <h3>Progression de la Note Moyenne</h3>
            <canvas id="ratingLineChart"></canvas>
        </div>

        <div class="tile" id="recent-tile">
            <h3>Dernières Évaluations (Live)</h3>
            <ul id="recent-list">
                {% for prompt in recent_prompts %}
                    <li class="border-{{ prompt.risk.lower() }}">
                        <strong>{{ prompt.problem }}</strong>
                        Note: <span class="{{ get_rating_color_class(prompt.rating) }}">{{ prompt.rating }}</span> | 
                        Risque: <span class="{{ get_risk_color_class(prompt.risk) }}">{{ prompt.risk }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="tile" id="overall-avg-tile">
            <h3>Note Moyenne Globale</h3>
            <div class="big-number {{ get_rating_color_class(overall_avg) }}">
                {{ overall_avg }}
            </div>
        </div>

        <div class="tile" id="topics-tile">
            <h3>Top 3 Sujets Problématiques</h3>
            <ul class="topics-list">
                {% for topic in top_topics %}
                <li>
                    <span class="topic-name">{{ topic.topic }}</span>
                    <span class="topic-count">{{ topic.count }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>

    </div>

    <script>
        // Options globales pour Chart.js en mode sombre
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.borderColor = '#444';

        // === 1. PIE CHART ===
        const ctxPie = document.getElementById('riskPieChart').getContext('2d');
        const pieChart = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['High', 'Medium', 'Low', 'None'],
                datasets: [{
                    label: 'Niveaux de Risque',
                    // Données injectées par Jinja2
                    data: [
                        {{ risk_counts.high }},
                        {{ risk_counts.medium }},
                        {{ risk_counts.low }},
                        {{ risk_counts.none }}
                    ],
                    // Couleurs (Rouge, Orange, Jaune, Vert)
                    backgroundColor: [
                        '#F44336',
                        '#FF9800',
                        '#FFEB3B',
                        '#4CAF50'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#e0e0e0' }
                    }
                }
            }
        });

        // === 2. LINE CHART ===
        const ctxLine = document.getElementById('ratingLineChart').getContext('2d');
        // Données injectées par Jinja2
        const movingAvgData = {{ moving_avg_data | tojson }};
        const ratingLabels = {{ rating_labels | tojson }};
        
        // Logique pour colorer les points du graphique comme demandé
        const pointColors = movingAvgData.map(val => {
            if (val >= 8) return '#4CAF50'; // Vert
            if (val >= 4) return '#FFEB3B'; // Jaune
            return '#F44336'; // Rouge
        });

        const lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: ratingLabels,
                datasets: [{
                    label: 'Note Moyenne Progressive',
                    data: movingAvgData,
                    borderColor: '#3E95CD', // Couleur de la ligne
                    tension: 0.1,
                    fill: false,
                    backgroundColor: pointColors, // Couleur des points
                    pointRadius: 4,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 0,
                        max: 10,
                        ticks: { color: '#e0e0e0' },
                        grid: { color: '#444' }
                    },
                    x: {
                        ticks: { color: '#e0e0e0' },
                        grid: { color: '#444' }
                    }
                }
            }
        });

        // === 3. POLLING (Mise à jour de tout le Dashboard) ===

        // Intervalle de 10 secondes (10000 ms)
        const pollInterval = 10000;

        async function updateDashboard() {
            try {
                const response = await fetch('/api/dashboard-data');
                if (!response.ok) return; // Ne fait rien si l'API échoue

                const data = await response.json();

                // === Mise à jour du PIE CHART ===
                pieChart.data.datasets[0].data = [
                    data.risk_counts.high,
                    data.risk_counts.medium,
                    data.risk_counts.low,
                    data.risk_counts.none
                ];
                pieChart.update();

                // === Mise à jour du LINE CHART ===
                lineChart.data.labels = data.rating_labels;
                lineChart.data.datasets[0].data = data.moving_avg_data;

                // Recalculer les couleurs des points
                const newPointColors = data.moving_avg_data.map(val => {
                    if (val >= 8) return '#4CAF50'; // Vert
                    if (val >= 4) return '#FFEB3B'; // Jaune
                    return '#F44336'; // Rouge
                });
                lineChart.data.datasets[0].backgroundColor = newPointColors;
                lineChart.update();

                // === Mise à jour de la liste des 5 RÉCENTS ===
                const list = document.getElementById('recent-list');
                list.innerHTML = '';

                data.recent_prompts.slice(0, 5).forEach(item => {
                    const li = document.createElement('li');
                    const ratingColorClass = (item.rating >= 8) ? 'text-green' : (item.rating >= 4) ? 'text-yellow' : 'text-red';
                    const riskColorClass = `risk-${item.risk.toLowerCase()}`;
                    const riskBorderClass = `border-${item.risk.toLowerCase()}`;

                    li.className = riskBorderClass;
                    li.innerHTML = `
                        <strong>${item.problem}</strong>
                        Note: <span class="${ratingColorClass}">${item.rating}</span> |
                        Risque: <span class="${riskColorClass}">${item.risk}</span>
                    `;
                    list.appendChild(li);
                });

                // === Mise à jour de la NOTE MOYENNE GLOBALE ===
                const avgElement = document.querySelector('#overall-avg-tile .big-number');
                avgElement.textContent = data.overall_avg;

                // Changer la couleur selon la note
                avgElement.className = 'big-number ' +
                    ((data.overall_avg >= 8) ? 'text-green' :
                     (data.overall_avg >= 4) ? 'text-yellow' : 'text-red');

                // === Mise à jour des TOP TOPICS ===
                const topicsList = document.querySelector('.topics-list');
                topicsList.innerHTML = '';

                data.top_topics.forEach(topic => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="topic-name">${topic.topic}</span>
                        <span class="topic-count">${topic.count}</span>
                    `;
                    topicsList.appendChild(li);
                });

            } catch (error) {
                console.error("Erreur lors du rafraîchissement du dashboard:", error);
            }
        }

        // Lance le polling
        setInterval(updateDashboard, pollInterval);

    </script>

</body>
</html>